var united=united||{},nav=null,geocoder=null,pin={name:"",city:"",state:"",zip:"",message:"",lat:null,lng:null};function requestPosition(a){null==nav&&(nav=window.navigator);if(null!=nav){var b=nav.geolocation;null!=b&&b.getCurrentPosition(function(b){successCallback(b,a)},function(){successCallback(null,a)})}else successCallback(null,a)}function successCallback(a,b){null!==a&&(pin.lat=a.coords.latitude,pin.lng=a.coords.longitude);b(initialize())}
function placeOverlayAt(a){function b(){c.getCenter();8<c.getZoom()&&i.intersects(c.getBounds())?overlay.show():overlay.hide()}var c=a.map,d=a.lat,g=a.lng,e=a.scale||1,h=a.difficulty||11,j=0.0040*e,k=0.0031*e,e=new google.maps.LatLng(d-j,g-k),d=new google.maps.LatLng(d+j,g+k),i=new google.maps.LatLngBounds(e,d);overlay=new MOverlay(i,"/img/monstercat_findme.png",c,h,a);var f=$("#catModal");google.maps.event.addListener(c,"zoom_changed",b);google.maps.event.addListener(c,"center_changed",b);google.maps.event.addListener(c,
"added_cat",function(a,b){$(a).click(function(){f.modal();$("#modalEggId",f).val(b.eggId);$("#modalMsg",f).text(b.message||"")})});$(".submit-cat",f).click(function(){if($("#modalEggId",f).val()===a.eggId){var b=$("#contestName",f).val(),c=$("#email",f).val();""===b||""===c?alert("Please fill in both fields"):$.ajax({type:"POST",url:"/found",data:{name:b,email:c,eggId:a.eggId,claimedAt:new Date},success:function(){f.modal("hide")},error:function(){alert("This has already been claimed, sorry :(");
f.modal("hide")}})}})}
function initialize(){geocoder=new google.maps.Geocoder;var a=39.49,b=-99.62,c=4;null!==pin.lat&&null!==pin.lng&&(a=pin.lat,b=pin.lng,c=10);var a={center:new google.maps.LatLng(a,b),zoom:c,mapTypeId:google.maps.MapTypeId.ROADMAP},d=new google.maps.Map(document.getElementById("map_canvas"),a),g=[{map:d,lat:29.975309,lng:31.137751,eggId:"a",difficulty:10,message:"The original Monstercat."},{map:d,lat:61.502224,lng:23.71985,eggId:"b",difficulty:9,message:"Oldest operational Sauna in Finland!"},{map:d,
lat:35.50936,lng:-105.918694,eggId:"c",difficulty:9,message:""},{map:d,lat:27.9856,lng:86.9233,eggId:"d",difficulty:10,message:"#OperationDethrone"},{map:d,lat:-19.39,lng:46.64,eggId:"e",difficulty:9,message:"You have found the secret Monstercat. SHUT. DOWN. EVERYTHING.",scale:8}];$.ajax({type:"GET",url:"/found",success:function(a){var b=_(g).filter(function(b){return!_(a).include(b.eggId)});_(b).each(placeOverlayAt)}});var e=new google.maps.InfoWindow({content:"loading"});$.ajax({type:"GET",url:"pins",
success:function(a){for(var a=a.results,b=0;b<a.length;b++){var c=a[b];$.cookie("unitedMarker")===c._id&&d.panTo(new google.maps.LatLng(c.lat,c.lng));placePin(c,d,e)}}});return{map:d,info_window:e}}
function placePin(a,b,c){var d=Math.random()/18,g=Math.random()/18,e=0.5<Math.random()?1:-1,h=0.5<Math.random()?1:-1,a=new google.maps.Marker({map:b,animation:google.maps.Animation.DROP,title:a.name,position:new google.maps.LatLng(a.lat+d*e,a.lng+g*h),html:"<p><strong>"+a.message+"</strong></p><br/><strong><i> - "+a.name+"</i></strong></footer>"});google.maps.event.addListener(a,"click",function(a){return function(){c.setContent(a.html);c.open(b,a)}}(a))}
function validate(a){var b=null,b=$("#name");if(""===b.val()||2>b.val().length)return b.closest(".control-group").addClass("error"),!1;pin.name=b.val();b=$("#location");if(""===b.val()||2>b.val().length)return b.closest(".control-group").addClass("error"),!1;pin.location=b.val();b=$("#msg");if(""===b.val()||1>=b.val().length||140<b.val().length)return b.closest(".control-group").addClass("error"),!1;pin.message=b.val();lat=$("#lat");lng=$("#lng");""===lat.val()&&""===lng.val()&&(b=$("#location").val(),
geocoder.geocode({address:b},function(a,b){if(b===google.maps.GeocoderStatus.OK)pin.lat=a[0].geometry.location.Xa,pin.lng=a[0].geometry.location.Ya;else return!1}));pin.lat=lat.val();pin.lng=lng.val();pin.recaptcha_challenge_field=Recaptcha.get_challenge();pin.recaptcha_response_field=Recaptcha.get_response();$.ajax({type:"POST",url:"",data:pin,success:function(){$("#form").slideUp();placePin(pin,a.data.map,a.data.info_window);a.data.map.panTo(new google.maps.LatLng(pin.lat,pin.lng));Recaptcha.destroy()},
error:function(a){a=JSON.parse(a.responseText);Recaptcha.reload();$("#form-err").show();$("#form-err").append("<strong>Error!</strong> "+a.err)}})}function MOverlay(a,b,c,d,g){this.ratio=160/212;this.difficulty=d||11;this.opts=g;this.bounds_=a;this.image_=b;this.map_=c;this.div_=null;this.setMap(c)}MOverlay.prototype=new google.maps.OverlayView;
MOverlay.prototype.onAdd=function(){var a=document.createElement("div");$(a);a.style.border="none";a.style.borderWidth="0px";a.style.position="absolute";a.style.cursor="pointer";var b=document.createElement("img");b.src=this.image_;b.style.width="100%";b.style.height="100%";a.appendChild(b);this.div_=a;this.getPanes().overlayImage.appendChild(this.div_);google.maps.event.trigger(this.map_,"added_cat",a,this.opts)};function sigmoid(a){return 1/(1+Math.pow(2.71828182846,-a))}
MOverlay.prototype.draw=function(){if(this.div_){var a=this.getProjection(),b=a.fromLatLngToDivPixel(this.bounds_.getSouthWest()),c=a.fromLatLngToDivPixel(this.bounds_.getNorthEast()),a=this.div_;$(this.div_);a.style.left=b.x+"px";a.style.top=c.y+"px";a.style.width=c.x-b.x+"px";a.style.height=b.y-c.y+"px";b=this.map_.getZoom();b=sigmoid(b-this.difficulty);a.style.opacity=b}};
MOverlay.prototype.remove=function(){this.div_&&this.div_.parentNode&&(this.div_.parentNode.removeChild(this.div_),this.div_=null)};MOverlay.prototype.onRemove=function(){this.remove()};MOverlay.prototype.hide=function(){if(this.div_)this.onRemove()};MOverlay.prototype.show=function(){this.div_||(this.onAdd(),this.draw())};united.MOverlay=MOverlay;
