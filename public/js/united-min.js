var united=united||{},nav=null,geocoder=null,pin={name:"",city:"",state:"",zip:"",message:"",lat:null,lng:null};function requestPosition(a){null==nav&&(nav=window.navigator);if(null!=nav){var b=nav.geolocation;null!=b&&b.getCurrentPosition(function(b){successCallback(b,a)},function(){successCallback(null,a)})}else successCallback(null,a)}function successCallback(a,b){null!==a&&(pin.lat=a.coords.latitude,pin.lng=a.coords.longitude);b(initialize())}
function placeOverlayAt(a,b){function c(){a.getCenter();8<a.getZoom()&&i.intersects(a.getBounds())?j.show():j.hide()}var d=b.lat,e=b.lng,f=b.scale||0.2,h=b.difficulty||12,k=0.0040*f,l=0.0031*f,f=new google.maps.LatLng(d-k,e-l),d=new google.maps.LatLng(d+k,e+l),i=new google.maps.LatLngBounds(f,d),j=new MOverlay(i,"/img/monstercat_findme.png",a,h,b),g=$("#catModal");google.maps.event.addListener(a,"zoom_changed",c);google.maps.event.addListener(a,"center_changed",c);google.maps.event.addListener(a,
"added_cat",function(a,b){$(a).click(function(){g.modal();$("#modalEggId",g).val(b.eggId);$("#modalMsg",g).text(b.message||"")})});$(".submit-cat",g).click(function(){if($("#modalEggId",g).val()===b.eggId){var a=$("#contestName",g).val(),c=$("#email",g).val();""===a||""===c?alert("Please fill in both fields"):$.ajax({type:"POST",url:"/found",data:{name:a,email:c,eggId:b.eggId,claimedAt:new Date},success:function(){g.modal("hide")},error:function(){alert("This has already been claimed, sorry :(");
g.modal("hide")}})}})}
function initialize(){geocoder=new google.maps.Geocoder;var a=39.49,b=-99.62,c=4;null!==pin.lat&&null!==pin.lng&&(a=pin.lat,b=pin.lng,c=10);var a={center:new google.maps.LatLng(a,b),zoom:c,mapTypeId:google.maps.MapTypeId.ROADMAP},d=new google.maps.Map(document.getElementById("map_canvas"),a),e=new google.maps.InfoWindow({content:"loading"});$.ajax({type:"GET",url:"pins",success:function(a){for(var a=a.results,b=0;b<a.length;b++){var c=a[b];$.cookie("unitedMarker")===c._id&&d.panTo(new google.maps.LatLng(c.lat,c.lng));
placePin(c,d,e)}}});var f={},h=_.throttle(function(a,b){$.ajax({type:"GET",url:"/isNear",data:{lat:a.lat(),lng:a.lng()},success:b})},500),a=function(){var a=d.getZoom(),b=d.getCenter();a>8&&h(b,function(a){if(!f[a.eggId]){f[a.eggId]=a;placeOverlayAt(d,a)}})};google.maps.event.addListener(d,"zoom_changed",a);google.maps.event.addListener(d,"center_changed",a);return{map:d,info_window:e}}
function placePin(a,b,c){var d=Math.random()/18,e=Math.random()/18,f=0.5<Math.random()?1:-1,h=0.5<Math.random()?1:-1,a=new google.maps.Marker({map:b,animation:google.maps.Animation.DROP,title:a.name,position:new google.maps.LatLng(a.lat+d*f,a.lng+e*h),html:"<p><strong>"+a.message+"</strong></p><br/><strong><i> - "+a.name+"</i></strong></footer>"});google.maps.event.addListener(a,"click",function(a){return function(){c.setContent(a.html);c.open(b,a)}}(a))}
function validate(a){var b=null,b=$("#name");if(""===b.val()||2>b.val().length)return b.closest(".control-group").addClass("error"),!1;pin.name=b.val();b=$("#location");if(""===b.val()||2>b.val().length)return b.closest(".control-group").addClass("error"),!1;pin.location=b.val();b=$("#msg");if(""===b.val()||1>=b.val().length||140<b.val().length)return b.closest(".control-group").addClass("error"),!1;pin.message=b.val();lat=$("#lat");lng=$("#lng");""===lat.val()&&""===lng.val()&&(b=$("#location").val(),
geocoder.geocode({address:b},function(a,b){if(b===google.maps.GeocoderStatus.OK)pin.lat=a[0].geometry.location.Xa,pin.lng=a[0].geometry.location.Ya;else return!1}));pin.lat=lat.val();pin.lng=lng.val();pin.recaptcha_challenge_field=Recaptcha.get_challenge();pin.recaptcha_response_field=Recaptcha.get_response();$.ajax({type:"POST",url:"",data:pin,success:function(){$("#form").slideUp();placePin(pin,a.data.map,a.data.info_window);a.data.map.panTo(new google.maps.LatLng(pin.lat,pin.lng));Recaptcha.destroy()},
error:function(a){a=JSON.parse(a.responseText);Recaptcha.reload();$("#form-err").show();$("#form-err").append("<strong>Error!</strong> "+a.err)}})}function MOverlay(a,b,c,d,e){this.ratio=160/212;this.difficulty=d||11;this.opts=e;this.bounds_=a;this.image_=b;this.map_=c;this.div_=null;this.setMap(c);this.remove()}MOverlay.prototype=new google.maps.OverlayView;
MOverlay.prototype.onAdd=function(){var a=document.createElement("div");$(a);a.style.border="none";a.style.borderWidth="0px";a.style.position="absolute";a.style.cursor="pointer";var b=document.createElement("img");b.src=this.image_;b.style.width="100%";b.style.height="100%";a.appendChild(b);this.div_=a;this.getPanes().overlayImage.appendChild(this.div_);google.maps.event.trigger(this.map_,"added_cat",a,this.opts)};function sigmoid(a){return 1/(1+Math.pow(2.71828182846,-a))}
MOverlay.prototype.draw=function(){if(this.div_){var a=this.getProjection(),b=a.fromLatLngToDivPixel(this.bounds_.getSouthWest()),c=a.fromLatLngToDivPixel(this.bounds_.getNorthEast()),a=this.div_;$(this.div_);a.style.left=b.x+"px";a.style.top=c.y+"px";a.style.width=c.x-b.x+"px";a.style.height=b.y-c.y+"px";b=this.map_.getZoom();b=sigmoid(b-this.difficulty);a.style.opacity=b}};MOverlay.prototype.remove=function(){this.div_&&($(this.div_).remove(),this.div_=null)};MOverlay.prototype.onRemove=function(){this.remove()};
MOverlay.prototype.hide=function(){if(this.div_)this.onRemove()};MOverlay.prototype.show=function(){this.div_||(this.onAdd(),this.draw())};united.MOverlay=MOverlay;
